<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Sess√£o - Na R√©gua</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .status-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .status-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .label {
            font-weight: bold;
            color: #666;
        }

        .value {
            color: #333;
        }

        .success {
            color: #28a745;
            font-weight: bold;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }

        .warning {
            color: #ffc107;
            font-weight: bold;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .test-result.show {
            display: block;
        }

        .test-result.pass {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .test-result.fail {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .logs {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #858585;
            margin-right: 10px;
        }

        .log-success {
            color: #4ec9b0;
        }

        .log-error {
            color: #f48771;
        }

        .log-info {
            color: #569cd6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Sess√£o - Na R√©gua</h1>

        <div class="status-box">
            <h3>üìä Status da Sess√£o</h3>
            <div class="info-row">
                <span class="label">Autenticado:</span>
                <span class="value" id="statusAuth">Verificando...</span>
            </div>
            <div class="info-row">
                <span class="label">Usu√°rio:</span>
                <span class="value" id="statusUser">-</span>
            </div>
            <div class="info-row">
                <span class="label">Tipo:</span>
                <span class="value" id="statusTipo">-</span>
            </div>
            <div class="info-row">
                <span class="label">Email:</span>
                <span class="value" id="statusEmail">-</span>
            </div>
            <div class="info-row">
                <span class="label">Sess√£o Expira:</span>
                <span class="value" id="statusExpira">-</span>
            </div>
        </div>

        <div class="status-box">
            <h3>üîß Listeners Ativos</h3>
            <div class="info-row">
                <span class="label">visibilitychange:</span>
                <span class="value success" id="listenerVisibility">‚úì Ativo</span>
            </div>
            <div class="info-row">
                <span class="label">focus:</span>
                <span class="value success" id="listenerFocus">‚úì Ativo</span>
            </div>
            <div class="info-row">
                <span class="label">sessionLoaded:</span>
                <span class="value success" id="listenerSession">‚úì Ativo</span>
            </div>
            <div class="info-row">
                <span class="label">Salvamento Autom√°tico:</span>
                <span class="value success" id="autoSave">‚úì A cada 30s</span>
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-primary" onclick="testarMudancaAba()">
                üîÑ Simular Mudan√ßa de Aba
            </button>
            <button class="btn-success" onclick="testarRecarregarSessao()">
                ‚ôªÔ∏è Recarregar Sess√£o
            </button>
            <button class="btn-warning" onclick="verificarLocalStorage()">
                üíæ Ver localStorage
            </button>
            <button class="btn-danger" onclick="limparSessao()">
                üóëÔ∏è Limpar Sess√£o
            </button>
        </div>

        <div class="btn-group">
            <button class="btn-primary" onclick="testarLogin()">
                üîë Testar Login
            </button>
            <button class="btn-success" onclick="executarTodosTests()">
                ‚úÖ Executar Todos os Testes
            </button>
        </div>

        <div id="testResult" class="test-result"></div>

        <div class="logs" id="logs">
            <div class="log-entry">
                <span class="log-time">[Carregado]</span>
                <span class="log-info">Sistema de testes inicializado</span>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let logCount = 0;

        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const now = new Date();
            const time = now.toLocaleTimeString('pt-BR');
            
            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-${type}">${message}</span>
            `;
            
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            
            logCount++;
            if (logCount > 50) {
                logs.removeChild(logs.firstChild);
                logCount--;
            }
        }

        function showTestResult(message, passed) {
            const result = document.getElementById('testResult');
            result.textContent = message;
            result.className = 'test-result show ' + (passed ? 'pass' : 'fail');
            
            setTimeout(() => {
                result.classList.remove('show');
            }, 5000);
        }

        function atualizarStatus() {
            if (window.auth) {
                const isAuth = window.auth.isAuthenticated();
                const user = window.auth.getCurrentUser();
                
                document.getElementById('statusAuth').innerHTML = isAuth 
                    ? '<span class="success">‚úì Sim</span>' 
                    : '<span class="error">‚úó N√£o</span>';
                
                if (user) {
                    document.getElementById('statusUser').textContent = user.nome;
                    document.getElementById('statusTipo').innerHTML = user.tipo === 'barbeiro'
                        ? '<span class="success">üíà Barbeiro</span>'
                        : '<span class="success">üë§ Cliente</span>';
                    document.getElementById('statusEmail').textContent = user.email;
                    
                    const sessionData = localStorage.getItem('naRegua_session');
                    if (sessionData) {
                        const session = JSON.parse(sessionData);
                        const expira = new Date(session.timestamp);
                        expira.setHours(expira.getHours() + 24);
                        document.getElementById('statusExpira').textContent = expira.toLocaleString('pt-BR');
                    }
                } else {
                    document.getElementById('statusUser').textContent = '-';
                    document.getElementById('statusTipo').textContent = '-';
                    document.getElementById('statusEmail').textContent = '-';
                    document.getElementById('statusExpira').textContent = '-';
                }
            }
        }

        function testarMudancaAba() {
            addLog('üîÑ Simulando mudan√ßa de aba...', 'info');
            
            // Simular perda de visibilidade
            const event = new Event('visibilitychange');
            Object.defineProperty(document, 'hidden', { value: true, writable: true });
            document.dispatchEvent(event);
            
            addLog('üì¥ Aba marcada como oculta', 'info');
            
            setTimeout(() => {
                // Simular retorno de visibilidade
                Object.defineProperty(document, 'hidden', { value: false, writable: true });
                document.dispatchEvent(event);
                addLog('üì± Aba reativada - sess√£o recarregada', 'success');
                atualizarStatus();
                showTestResult('‚úÖ Teste de mudan√ßa de aba conclu√≠do com sucesso!', true);
            }, 2000);
        }

        function testarRecarregarSessao() {
            addLog('‚ôªÔ∏è Recarregando sess√£o manualmente...', 'info');
            
            if (window.auth) {
                window.auth.loadSession();
                atualizarStatus();
                addLog('‚úì Sess√£o recarregada com sucesso', 'success');
                showTestResult('‚úÖ Sess√£o recarregada!', true);
            } else {
                addLog('‚úó AuthManager n√£o dispon√≠vel', 'error');
                showTestResult('‚ùå Erro: AuthManager n√£o encontrado', false);
            }
        }

        function verificarLocalStorage() {
            addLog('üíæ Verificando localStorage...', 'info');
            
            const keys = [
                'naRegua_session',
                'naRegua_clientes',
                'naRegua_barbeirosAuth',
                'naRegua_agendamentos'
            ];
            
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    const size = new Blob([data]).size;
                    addLog(`‚úì ${key}: ${size} bytes`, 'success');
                    console.log(key, JSON.parse(data));
                } else {
                    addLog(`‚úó ${key}: n√£o encontrado`, 'error');
                }
            });
            
            showTestResult('‚úÖ Verifique o console para detalhes do localStorage', true);
        }

        function limparSessao() {
            if (confirm('‚ö†Ô∏è Tem certeza que deseja limpar a sess√£o?')) {
                addLog('üóëÔ∏è Limpando sess√£o...', 'info');
                
                if (window.auth) {
                    window.auth.logout();
                    atualizarStatus();
                    addLog('‚úì Sess√£o limpa com sucesso', 'success');
                    showTestResult('‚úÖ Sess√£o limpa!', true);
                } else {
                    localStorage.removeItem('naRegua_session');
                    atualizarStatus();
                    addLog('‚úì Sess√£o removida manualmente', 'success');
                    showTestResult('‚úÖ Sess√£o removida!', true);
                }
            }
        }

        function testarLogin() {
            addLog('üîë Testando login...', 'info');
            
            if (!window.auth) {
                addLog('‚úó AuthManager n√£o dispon√≠vel', 'error');
                showTestResult('‚ùå Erro: AuthManager n√£o encontrado', false);
                return;
            }
            
            const result = window.auth.login('joao@email.com', '123456');
            
            if (result.success) {
                addLog('‚úì Login realizado: ' + result.user.nome, 'success');
                atualizarStatus();
                showTestResult('‚úÖ Login bem-sucedido!', true);
            } else {
                addLog('‚úó Falha no login: ' + result.message, 'error');
                showTestResult('‚ùå Falha no login: ' + result.message, false);
            }
        }

        function executarTodosTests() {
            addLog('üöÄ Executando bateria completa de testes...', 'info');
            
            let testsPassed = 0;
            let testsFailed = 0;
            
            // Teste 1: AuthManager existe
            if (window.auth) {
                addLog('‚úì Teste 1: AuthManager inicializado', 'success');
                testsPassed++;
            } else {
                addLog('‚úó Teste 1: AuthManager n√£o encontrado', 'error');
                testsFailed++;
            }
            
            // Teste 2: DatabaseManager existe
            if (window.db) {
                addLog('‚úì Teste 2: DatabaseManager inicializado', 'success');
                testsPassed++;
            } else {
                addLog('‚úó Teste 2: DatabaseManager n√£o encontrado', 'error');
                testsFailed++;
            }
            
            // Teste 3: localStorage dispon√≠vel
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                addLog('‚úì Teste 3: localStorage dispon√≠vel', 'success');
                testsPassed++;
            } catch(e) {
                addLog('‚úó Teste 3: localStorage n√£o dispon√≠vel', 'error');
                testsFailed++;
            }
            
            // Teste 4: Sess√£o pode ser salva
            if (window.auth && window.auth.currentUser) {
                const sessionData = localStorage.getItem('naRegua_session');
                if (sessionData) {
                    addLog('‚úì Teste 4: Sess√£o salva corretamente', 'success');
                    testsPassed++;
                } else {
                    addLog('‚ö† Teste 4: Nenhuma sess√£o ativa no momento', 'info');
                }
            }
            
            // Teste 5: Eventos customizados funcionam
            let eventReceived = false;
            const testListener = () => { eventReceived = true; };
            window.addEventListener('sessionLoaded', testListener);
            window.dispatchEvent(new CustomEvent('sessionLoaded'));
            
            if (eventReceived) {
                addLog('‚úì Teste 5: Eventos customizados funcionando', 'success');
                testsPassed++;
            } else {
                addLog('‚úó Teste 5: Eventos customizados com problema', 'error');
                testsFailed++;
            }
            window.removeEventListener('sessionLoaded', testListener);
            
            // Resultado final
            const total = testsPassed + testsFailed;
            const message = `Testes conclu√≠dos: ${testsPassed}/${total} passaram`;
            
            if (testsFailed === 0) {
                addLog(`üéâ ${message} - Tudo funcionando!`, 'success');
                showTestResult(`‚úÖ ${message}`, true);
            } else {
                addLog(`‚ö†Ô∏è ${message} - ${testsFailed} falharam`, 'error');
                showTestResult(`‚ö†Ô∏è ${message}`, false);
            }
        }

        // Listener para evento de sess√£o
        window.addEventListener('sessionLoaded', function(event) {
            addLog('üì° Evento sessionLoaded recebido', 'success');
            atualizarStatus();
        });

        // Listener para visibilitychange
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                addLog('üëÅÔ∏è Aba voltou ao foco', 'info');
            } else {
                addLog('üí§ Aba ficou em background', 'info');
            }
        });

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addLog('‚úì Sistema de testes carregado', 'success');
            atualizarStatus();
            
            // Verificar se j√° est√° logado
            if (window.auth && window.auth.isAuthenticated()) {
                addLog('‚úì Usu√°rio j√° est√° logado', 'success');
            } else {
                addLog('‚ÑπÔ∏è Nenhum usu√°rio logado no momento', 'info');
            }
        });
    </script>
</body>
</html>
